# 引擎与渲染器原理

我们内置了 react 和 vue 的引擎。首先，你需要理解，在 formast 中什么是引擎，简单讲，就是可完成界面渲染的独立工具。
Formast 之所以被称为框架，因为它由三个部分组件，三个部分一起运行才能正常工作，但是，你可以根据自己的需求，组合实现三部分，因此，它是一个框架。这三个部分分别是：

组成部分 | 作用
--|--
集成包 | 提供具体的交互组件
引擎 | 基于UI框架渲染
Schema 解析器 | 解析后端接口返回的 JSON

三个部分环环相扣，缺一不可。这里主要讲的是引擎层。

引擎层简单讲就是在解析器解析结果的基础上，可以结合具体的UI框架（react、vue）实现界面渲染。

它需要向解析器提供渲染器，渲染器是一个函数（render 宏），在创建引擎时，引用解析器，并把渲染器作为 render 宏交给渲染器。为什么要这么设计呢？因为我们希望做到一次遍历即可完成渲染，解析 JSON 的过程就是遍历 JSON 节点的过程，如果先让解析器工作，再让引擎渲染，那么必然经过两次遍历，性能受到影响。因此，我们设计成 render 宏的形式，解析器在解析过程中，直接使用宏进行处理，而 render 宏的处理结果即产生具体的 react 组件或 vue 组件。这样就可以经过一次遍历，得到可结合具体框架渲染的组件，性能大幅提升。

接下来就来分析一下渲染器。

引擎首先要创建一个自己的渲染器，然后利用解析器暴露出来的接口，把渲染器交给解析器后执行。我们看下 react 的渲染器是怎么做的。

```js
function render(data, compute, context, subscribe) {
  // 返回组件实例
}
```

渲染器本身是一个函数，它的参数是解析器内部固定传的。解析器在解析到某个节点的时候，会根据节点的情况，使用不同的宏进行解析，而遇到 render 宏的时候，就会用上面这个渲染器函数进行解析，渲染器会返回对应的 react 组件实例，这样，在遍历完 JSON 之后，就形成了组件套组件的 react 组件体系。

但是，这个组件是怎么构造出来的呢？这时就需要在引擎里面去实现用于渲染的组件。

我们传入的 `components` 参数包含了需要用到的全部组件，引擎利用渲染器函数里面得到的信息，就可以选择使用对应的组件。如此慢慢构造，就可以让解析器在完成遍历时，得到我们需要的东西。引擎就是在这个过程中完成了解析和组件体系搭建的过程。

这里只是讲解了引擎与渲染原理的思路，顺着这个思路，你可以阅读源码来了解引擎的具体实现过程。
